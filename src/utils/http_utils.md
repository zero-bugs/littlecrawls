9iaW4vcHl0aG9uMwojIC0qLSBjb2Rpbmc6IFVURi04IC0qLQppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHRpbWUKaW1wb3J0IHV1aWQKCmltcG9ydCByZXF1ZXN0cwpmcm9tIGJzNCBpbXBvcnQgQmVhdXRpZnVsU291cApmcm9tIHJlcXVlc3RzLnV0aWxzIGltcG9ydCBkaWN0X2Zyb21fY29va2llamFyCgpmcm9tIHNyYy5jb21tb24uY29tbW9uX2NvbmZpZyBpbXBvcnQgQ29tbW9uQ29uc3RhbnQKZnJvbSBzcmMuY29tbW9uLnByb3h5X2NvbmZpZyBpbXBvcnQgUHJveHlDb25zdGFudApmcm9tIHNyYy5kYi5zcV9jb25uZWN0aW9uIGltcG9ydCBzcWxpdGVNYW5hZ2VyCmZyb20gcmVxdWVzdHMuY29va2llcyBpbXBvcnQgUmVxdWVzdHNDb29raWVKYXIKCgpjbGFzcyBIdHRwQ2xpZW50OgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYuY3VycmVudENvb2tpZSA9IE5vbmUKICAgICAgICBzZWxmLmxhc3RVcGRhdGVDb29raWVUaW1lID0gTm9uZQogICAgICAgIHNlbGYubGFzdFVwZGF0ZVV1aWRUaW1lID0gTm9uZQogICAgICAgIHNlbGYudHJhY2VDb29raWUgPSBbJ19wa19pZC4xLjAxYjgnLCAnX3BrX3Nlcy4xLjAxYjgnXQogICAgICAgIHNlbGYuY29va2llTmFtZVByZWZpeExpc3QgPSBbCiAgICAgICAgICAgICdfX2NmZHVpZCcsCiAgICAgICAgICAgICdYU1JGLVRPS0VOJywKICAgICAgICAgICAgJ3dhbGxoYXZlbl9zZXNzaW9uJywKICAgICAgICAgICAgJ3JlbWVtYmVyX3dlYicKICAgICAgICBdCgogICAgZGVmIGh0dHBfcmV0cnlfZXhlY3V0b3Ioc2VsZiwgdXJsLCBoZWFkZXJzOiBkaWN0LCBwYXlsb2FkPU5vbmUsIG1ldGhvZD0nZ2V0JywgdXNlQ29va2llPUZhbHNlKToKICAgICAgICBpZiBwYXlsb2FkIGlzIE5vbmU6CiAgICAgICAgICAgIHBheWxvYWQgPSB7fQogICAgICAgIGlmIGhlYWRlcnMgaXMgTm9uZToKICAgICAgICAgICAgaGVhZGVycyA9IHt9CgogICAgICAgIHJldHJ5ID0gRmFsc2UKICAgICAgICBwcm94eSA9IFByb3h5Q29uc3RhbnQucHJveGllcyBpZiBQcm94eUNvbnN0YW50LnByb3h5U3dpdGNoIGVsc2UgTm9uZQoKICAgICAgICAjIGNvbW1vbiBoZWFkZXJzCiAgICAgICAgaGVhZGVyc1sndXNlci1hZ2VudCddPSdNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXaW42NDsgeDY0KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvODcuMC40MjgwLjg4IFNhZmFyaS81MzcuMzYnCiAgICAgICAgaGVhZGVyc1snb3JpZ2luJ109ICJ7fSIuZm9ybWF0KENvbW1vbkNvbnN0YW50LndhbGxfaGF2ZW5fdXJsKQogICAgICAgIGhlYWRlcnNbJ2FjY2VwdCddPSd0ZXh0L2h0bWwsYXBwbGljYXRpb24veGh0bWwreG1sLGFwcGxpY2F0aW9uL3htbDtxPTAuOSxpbWFnZS9hdmlmLGltYWdlL3dlYnAsaW1hZ2UvYXBuZywqLyo7cT0wLjgsYXBwbGljYXRpb24vc2lnbmVkLWV4Y2hhbmdlO3Y9YjM7cT0wLjknCiAgICAgICAgaGVhZGVyc1snYWNjZXB0LWxhbmd1YWdlJ10gPSAnemgtQ04semg7cT0wLjknCgogICAgICAgIGNvb2tpZUphciA9IFJlcXVlc3RzQ29va2llSmFyKCkKICAgICAgICBpZiB1c2VDb29raWUgYW5kIHNlbGYuY3VycmVudENvb2tpZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgY29va2llSmFyID0gc2VsZi5jdXJyZW50Q29va2llCiAgICAgICAgZWxpZiB1c2VDb29raWUgYW5kIHNlbGYuY3VycmVudENvb2tpZSBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmxvZ2luSW4oKQoKICAgICAgICBmb3IgbnVtIGluIHJhbmdlKDAsIDUpOgogICAgICAgICAgICBpZiByZXRyeToKICAgICAgICAgICAgICAgIHByaW50KCJyZXRyeSB1cmw6e30gZm9yIHt9IHRpbWUiLmZvcm1hdCh1cmwsIG51bSkpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlc3AgPSBOb25lCiAgICAgICAgICAgICAgICBpZiBtZXRob2QgPT0gJ3Bvc3QnOgogICAgICAgICAgICAgICAgICAgIGhlYWRlcnNbJ2FjY2VwdC1lbmNvZGluZyddID0gJ2d6aXAsIGRlZmxhdGUsIGJyJwogICAgICAgICAgICAgICAgICAgICMgaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJwogICAgICAgICAgICAgICAgICAgIHJlc3AgPSByZXF1ZXN0cy5wb3N0KHVybCwgZGF0YT1wYXlsb2FkLCB2ZXJpZnk9VHJ1ZSwgdGltZW91dD0xMjAsIHByb3hpZXM9cHJveHksIGhlYWRlcnM9aGVhZGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVzPWNvb2tpZUphciwgYWxsb3dfcmVkaXJlY3RzPUZhbHNlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXNwID0gcmVxdWVzdHMuZ2V0KHVybCwgdmVyaWZ5PVRydWUsIHRpbWVvdXQ9MTIwLCBwcm94aWVzPXByb3h5LCBoZWFkZXJzPWhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29raWVzPWNvb2tpZUphciwgIGFsbG93X3JlZGlyZWN0cz1GYWxzZSkKICAgICAgICAgICAgICAgIGlmIHJlc3AgaXMgbm90IE5vbmUgYW5kIHJlc3Auc3RhdHVzX2NvZGUgPCA0MDA6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51cGRhdGVDb29raWUocmVzcCkKICAgICAgICAgICAgICAgIGVsaWYgcmVzcCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICBwcmludCgncmVxdWVzdCBleGNlcHRpb24sIHN0YXR1cyBjb2RlOnt9LCBtZXRob2Q6e30sIHVybDp7fScuZm9ybWF0KHJlc3Auc3RhdHVzX2NvZGUsIG1ldGhvZCwgdXJsKSkKICAgICAgICAgICAgICAgICAgICBwcmludCgncmVxdWVzdCBjb29raWU6e30nLmZvcm1hdChjb29raWVKYXIpKQogICAgICAgICAgICAgICAgICAgIHByaW50KCdyZXNwIGNvb2tpZTp7fScuZm9ybWF0KHJlc3AuY29va2llcykpCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoJ3JlcXVlc3QgaGVhZGVyczp7fScuZm9ybWF0KGhlYWRlcnMpKQogICAgICAgICAgICAgICAgICAgIHByaW50KCdyZXNwb25zZSBoZWFkZXJzOnt9Jy5mb3JtYXQocmVzcC5oZWFkZXJzKSkKICAgICAgICAgICAgICAgICAgICBwcmludCgncmVxdWVzdCBwYXlsb2FkOnt9LHR5cGU6e30nLmZvcm1hdChwYXlsb2FkLCB0eXBlKHBheWxvYWQpKSkKCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCdyZXNwIGlzIG51bGwsIGNvb2tpZTp7fSwgdXJsOnt9Jy5mb3JtYXQoc2VsZi5jdXJyZW50Q29va2llLCB1cmwpKQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3AKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlcnI6CiAgICAgICAgICAgICAgICBwcmludCgiaHR0cCByZXF1ZXN0IGZhaWxlZCwgcmV0cnkgdXJsOnt9Ii5mb3JtYXQodXJsKSkKICAgICAgICAgICAgICAgIHByaW50KGVycikKCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKCiAgICAgICAgICAgIHJldHJ5ID0gVHJ1ZQogICAgICAgICAgICBpZiBudW0gPT0gNDoKICAgICAgICAgICAgICAgIHByaW50KCJmYWlsZWQgYXQgbGFzdCwgcGxlYXNlIHRyeSBieSBoYW5kcyIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBsb2dpbkluKHNlbGYpOgogICAgICAgIHJlc3AgPSBzZWxmLmh0dHBfcmV0cnlfZXhlY3V0b3IoInt9L2xvZ2luIi5mb3JtYXQoQ29tbW9uQ29uc3RhbnQud2FsbF9oYXZlbl91cmwpLCB7fSkKICAgICAgICBpZiByZXNwIGlzIE5vbmUgb3IgcmVzcC5zdGF0dXNfY29kZSAhPSAyMDA6CiAgICAgICAgICAgIHByaW50KCdsb2dpbiBpbiBlcnJvciwgY29kZTp7fScuZm9ybWF0KHJlc3ApKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBzb3VwID0gQmVhdXRpZnVsU291cChyZXNwLnRleHQsICdodG1sLnBhcnNlcicpCiAgICAgICAgdG9rZW4gPSBzb3VwLnNlbGVjdCgnI2xvZ2luID4gaW5wdXRbdHlwZT1oaWRkZW5dOm50aC1jaGlsZCgxKScpWzBdWyd2YWx1ZSddCgogICAgICAgIHByaW50KCdvYnRhaW4gX3Rva2VuOnt9Jy5mb3JtYXQodG9rZW4pKQoKICAgICAgICByZXNwID0gc2VsZi5odHRwX3JldHJ5X2V4ZWN1dG9yKCJ7fS9hdXRoL2xvZ2luIi5mb3JtYXQoQ29tbW9uQ29uc3RhbnQud2FsbF9oYXZlbl91cmwpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZWZlcmVyJzogInt9L2xvZ2luIi5mb3JtYXQoQ29tbW9uQ29uc3RhbnQud2FsbF9oYXZlbl91cmwpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvcmlnaW4nOiBDb21tb25Db25zdGFudC53YWxsX2hhdmVuX3VybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2VjLWZldGNoLXNpdGUnOiAnc2FtZS1vcmlnaW4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzZWMtZmV0Y2gtZGVzdCc6ICdkb2N1bWVudCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NlYy1mZXRjaC1tb2RlJzogJ25hdmlnYXRlJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2VjLWZldGNoLXVzZXInOiAnPzEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1cGdyYWRlLWluc2VjdXJlLXJlcXVlc3RzJzogJzEnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBwYXlsb2FkPXsKICAgICAgICAgICAgICAgICdfdG9rZW4nOiB0b2tlbiwKICAgICAgICAgICAgICAgICd1c2VybmFtZSc6IENvbW1vbkNvbnN0YW50LnVzZXJuYW1lLAogICAgICAgICAgICAgICAgJ3Bhc3N3b3JkJzogQ29tbW9uQ29uc3RhbnQucGFzc3dvcmQKICAgICAgICAgICAgfSwgbWV0aG9kPSdwb3N0JywgdXNlQ29va2llPVRydWUsICkKICAgICAgICBwcmludCgnbG9naW4gcmVxdWVzdCBjb2RlOnt9LCBoZWFkZXJzOnt9Jy5mb3JtYXQocmVzcC5zdGF0dXNfY29kZSwgcmVzcC5oZWFkZXJzKSkKICAgICAgICBpZiByZXNwLnN0YXR1c19jb2RlID09IDMwMjoKICAgICAgICAgICAgcHJpbnQoJ2dldCByZWRpcmVjdCBsb2NhdGlvbi0+e30gc3VjY2VzcycuZm9ybWF0KHJlc3AuaGVhZGVyc1snbG9jYXRpb24nXSkpCiAgICAgICAgICAgIGlmIHJlc3AuaGVhZGVyc1snbG9jYXRpb24nXSA9PSAne30vdXNlci97fScuZm9ybWF0KENvbW1vbkNvbnN0YW50LndhbGxfaGF2ZW5fdXJsLCBDb21tb25Db25zdGFudC51c2VybmFtZSk6CiAgICAgICAgICAgICAgICBwcmludCgnd2VsY29tZSB7fSB0byBhY2Nlc3Mgd2FsbGhhdmVuJy5mb3JtYXQoQ29tbW9uQ29uc3RhbnQudXNlcm5hbWUpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5jbGVhckNvb2tpZSgpCiAgICAgICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oJ3VzZXJuYW1lIG9yIHBhc3N3b3JkIGlzIHdyb25nJykKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmNsZWFyQ29va2llKCkKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdsb2dpbiBpbiB3YWxsaGF2ZW4gZmFpbGVkLicpCgogICAgZGVmIHVwZGF0ZUNvb2tpZShzZWxmLCByZXNwKToKICAgICAgICBpZiByZXNwIGlzIE5vbmUgb3IgcmVzcCA9PSAiIjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNlbGYuY3VycmVudENvb2tpZSA9IHJlc3AuY29va2llcwogICAgICAgIHNlbGYudXBkYXRlV2lwaWtJZChzZWxmLmN1cnJlbnRDb29raWUpCgogICAgICAgICMg5q+PMzDliIbpkp/mj5LlhaXkuIDmrKFjb29raWUKICAgICAgICBpZiAoc2VsZi5sYXN0VXBkYXRlQ29va2llVGltZSBpcyBOb25lIG9yCiAgICAgICAgICAgIGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpIC0gc2VsZi5sYXN0VXBkYXRlQ29va2llVGltZSA+IGRhdGV0aW1lLnRpbWVkZWx0YSgKICAgICAgICAgICAgICAgICAgICBtaW51dGVzPTMwKSkgYW5kIHNlbGYuY3VycmVudENvb2tpZToKICAgICAgICAgICAgaWYgc2VsZi5jb29raWVOYW1lUHJlZml4TGlzdFszXSBpbiBkaWN0X2Zyb21fY29va2llamFyKHNlbGYuY3VycmVudENvb2tpZSk6CiAgICAgICAgICAgICAgICBzcWxpdGVNYW5hZ2VyLmluc2VydF9jb21tb25fdGIoJ2Nvb2tpZXMnLCBzdHIoZGljdF9mcm9tX2Nvb2tpZWphcihzZWxmLmN1cnJlbnRDb29raWUpKSkKICAgICAgICAgICAgc2VsZi5sYXN0VXBkYXRlQ29va2llVGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCgogICAgZGVmIHVwZGF0ZVdpcGlrSWQoc2VsZiwgbXA6IFJlcXVlc3RzQ29va2llSmFyKToKICAgICAgICBpZiBtcCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBzZWxmLmxhc3RVcGRhdGVVdWlkVGltZSBpcyBOb25lIG9yIGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpIC0gc2VsZi5sYXN0VXBkYXRlVXVpZFRpbWUgPiBkYXRldGltZS50aW1lZGVsdGEoCiAgICAgICAgICAgICAgICBtaW51dGVzPTYwKToKICAgICAgICAgICAgdWlkID0gc3RyKHV1aWQudXVpZDUodXVpZC5OQU1FU1BBQ0VfT0lELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzg2LjAuNDI0MC43NSBTYWZhcmkvNTM3LjM2JykpLnJlcGxhY2UoCiAgICAgICAgICAgICAgICAnLScsICcnKVswOjE2XQogICAgICAgICAgICBjdXJ0aW1lID0gcm91bmQodGltZS50aW1lKCkpCgogICAgICAgICAgICBtcC5zZXQoc2VsZi50cmFjZUNvb2tpZVswXSwgInt9Lnt9Lnt9Lnt9Ii5mb3JtYXQodWlkLCBjdXJ0aW1lLCBjdXJ0aW1lLCBjdXJ0aW1lKSwgZG9tYWluPSd3YWxsaGF2ZW4uY2MnLAogICAgICAgICAgICAgICAgICAgcGF0aD0nLycpCiAgICAgICAgICAgIG1wLnNldChzZWxmLnRyYWNlQ29va2llWzFdLCAnMScsIGRvbWFpbj0nd2FsbGhhdmVuLmNjJywgcGF0aD0nLycpCgogICAgICAgICAgICBzZWxmLmxhc3RVcGRhdGVVdWlkVGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCgogICAgZGVmIGNsZWFyQ29va2llKHNlbGYpOgogICAgICAgIHNxbGl0ZU1hbmFnZXIuZGVsX2NvbW1vbl90YignJywgJ2Nvb2tpZXMnKQoKCmh0dHBDbGllbnQgPSBIdHRwQ2xpZW50KCkKIyAhL3Vzci
